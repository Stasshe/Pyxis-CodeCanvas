# AI編集 SEARCH/REPLACE ブロック解析の改善

## 概要

このドキュメントは、PyxisのAIコード編集で使用されるSEARCH/REPLACEブロック解析システムの改善について説明します。

## 修正された問題

### 元の問題

エージェント指示: 「searchメソッドが不十分。おそらく、マルチエディットをするときに、不具合が出る。修正して。また、test caseも。今のテストでは通ってしまう。もっと複雑な場合、多種多様な場合のエッヂケースを。」

### 具体的な不具合

1. **正規表現ベースの解析の失敗**
   - 空の置換ブロックの後に別のSEARCHブロックがある場合、パースが失敗
   - `[\s\S]*?` が次のブロックの内容も誤ってキャプチャ
   - 不完全なブロックの処理が不十分

2. **不十分なバリデーション**
   - マーカーの数だけをチェック
   - セパレーター（`=======`）の存在をチェックしていない
   - エラーメッセージが不明確

3. **テストの不足**
   - 完全なブロックのみをテスト
   - エッジケースのカバレッジが不足
   - マルチファイル・マルチ編集のテストがない

## 実装した修正

### 1. マニュアル解析アプローチ

**変更前**: 正規表現ベース
```typescript
const blockPattern = /<<<<<<< SEARCH\n([\s\S]*?)\n=======\n([\s\S]*?)\n>>>>>>> REPLACE/g;
```

**変更後**: シーケンシャル位置ベース
```typescript
while (currentIndex < section.length) {
  1. '<<<<<<< SEARCH' マーカーを検索
  2. '\n=======\n' セパレーターを検索
  3. '\n>>>>>>> REPLACE' マーカーを検索
  4. 位置間のコンテンツを抽出
  5. 不完全なブロックをスキップ
  6. 次のブロックに移動
}
```

**利点**:
- ✅ 空の置換ブロック（削除）を正しく処理
- ✅ ネストされたマーカーに対応
- ✅ 各ブロックを正確に分離
- ✅ 不完全なブロックを適切にスキップ

### 2. バリデーションの強化

```typescript
// セパレーターの存在チェックを追加
const completeBlocks = (response.match(completeBlockPattern) || []).length;
if (completeBlocks < searchCount && searchCount === replaceCount) {
  warnings.push('一部のSEARCH/REPLACEブロックにセパレーターがない可能性があります...');
}
```

### 3. 包括的なテストカバレッジ

**追加したテスト**: 36個の新しいテスト

#### エッジケーステスト (25個)
- 不完全/切断されたブロック
- 同じレスポンス内の有効/無効ブロックの混在
- 非常に長いコンテンツ（10,000文字以上）
- 特殊文字とネストされたマーカー
- 複数のSEARCHブロック（15個連続）
- 実世界の失敗シナリオ

#### 複雑なシナリオテスト (11個)
- 複数ファイルに複数の編集（ストレステスト: 20ファイル × 10編集）
- 連続した依存編集
- 大規模なリファクタリング
- 実世界のパターン（React、API、型定義）
- エラーリカバリー

## テスト結果

### 修正前
- 総テスト数: 127
- エッジケースのカバレッジ: 限定的
- マルチ編集シナリオ: テストなし

### 修正後
- **総テスト数: 163** ✅
- **エッジケーステスト: 25** ✅
- **複雑なシナリオテスト: 11** ✅
- **すべてのテストが合格** ✅

## サポートされるシナリオ

### ✅ 完全サポート

1. **1つのファイルに複数の編集**
   ```
   ### File: src/app.ts
   <<<<<<< SEARCH
   const a = 1;
   =======
   const a = 10;
   >>>>>>> REPLACE
   
   <<<<<<< SEARCH
   const b = 2;
   =======
   const b = 20;
   >>>>>>> REPLACE
   ```

2. **空の置換ブロック（削除）**
   ```
   <<<<<<< SEARCH
   const unused = true;
   =======
   >>>>>>> REPLACE
   ```

3. **連続した依存編集**
   - 最初の編集で型を追加
   - 2番目の編集で戻り値の型を追加
   - 3番目の編集でドキュメントを追加

4. **1つのレスポンスに複数のファイル**
   - 20ファイル以上をテスト済み
   - 1ファイルあたり10編集以上をテスト済み

5. **特殊文字**
   - 正規表現パターン
   - テンプレートリテラル
   - コンテンツ内のセパレーター

6. **非常に長いコンテンツ**
   - 10,000文字以上の行
   - 500行以上のファイル

## エラーハンドリング

### 部分的な成功

システムは以下を適切に処理します:
- 一部のファイルは成功、一部は失敗
- ファイル内の一部のブロックは成功、その他は失敗
- ブロックごとに詳細なエラー情報を返す

### バリデーションエラー

バリデーションが失敗した場合:
1. エラーを`[useAI]`プレフィックスでコンソールに記録
2. 有効な部分の解析を試みる
3. 可能な場合は部分的な結果を返す

## 実装の詳細

### パフォーマンス
- マニュアル解析は O(n) (n = レスポンスの長さ)
- 正規表現のバックトラック問題なし
- 大きなレスポンスを効率的に処理
- 200ブロック（20ファイル × 10編集）でテスト済み

### セキュリティ
- 解析中にコード実行なし
- コンテンツはプレーンテキストとして扱う
- レンダリングレイヤーでXSS防止
- 適用前の入力検証

## ベストプラクティス

### AI用

1. **SEARCHブロックに十分なコンテキストを提供**
   ```typescript
   // ❌ コンテキストが少なすぎ
   <<<<<<< SEARCH
   const x = 1;
   =======
   const x = 2;
   >>>>>>> REPLACE
   
   // ✅ より良い - 周囲のコードを含む
   <<<<<<< SEARCH
   function init() {
     const x = 1;
     return x;
   }
   =======
   function init() {
     const x = 2;
     return x;
   }
   >>>>>>> REPLACE
   ```

2. **正確なインデントと空白を使用**
   - オリジナルから正確なフォーマットをコピー
   - 末尾の空白は正規化される
   - 先頭の空白は重要

3. **1ブロックにつき1つの論理的変更**

### ユーザー用

1. **関連するファイルを選択**
   - 変更が必要なファイルを含める
   - コンテキストのために関連ファイルを含める
   - 無関係なファイルは含めない

2. **明確な指示を提供**
   - 何を変更するか具体的に
   - なぜ変更が必要か説明
   - 考慮すべきエッジケースに言及

3. **変更を注意深くレビュー**
   - 各ファイルの差分を確認
   - ロジックが正しいか検証
   - 適用後にテスト

## デバッグ

### ログの有効化

ブラウザコンソールで以下を確認:
```
[useAI] Response validation errors: [...]
[useAI] Selected files: [...]
[useAI] Response paths: [...]
[useAI] Parse result: [...]
```

### よくある問題

1. **"Mismatched SEARCH/REPLACE"**
   - レスポンスに不完全なブロックがないか確認
   - セパレーターが存在するか検証
   - 切断されたコンテンツを探す

2. **"Could not find matching text"**
   - SEARCHテキストがファイルと正確に一致しない
   - 空白とインデントを確認
   - より多くのコンテキストを追加してみる

3. **"Some file blocks may be malformed"**
   - レスポンスに構造的な問題がある
   - 一部のブロックにマーカーがない
   - バリデーション警告を確認

## 修正内容のまとめ

1. **マニュアル解析アプローチの実装** - 空の置換ブロックとネストされたマーカーを正しく処理
2. **バリデーションの強化** - セパレーターのチェックと詳細なエラーメッセージ
3. **包括的なテストカバレッジ** - 36の新しいテストを追加（エッジケースと複雑なシナリオ）
4. **ドキュメンテーション** - 実装の詳細とベストプラクティス

## バージョン履歴

### v0.17.1 (2026-01-01)
- ✨ マニュアル解析アプローチを実装
- ✨ 包括的なエッジケーステストを追加
- ✨ セパレーターチェックでバリデーションを強化
- ✨ 空の置換ブロック処理を修正
- 🐛 ネストされたブロック解析のバグを修正
- 📝 ドキュメンテーションを追加

## 関連ファイル

- `src/engine/ai/responseParser.ts` - メイン解析ロジック
- `src/engine/ai/patchApplier.ts` - ブロック適用
- `src/hooks/ai/useAI.ts` - UIとの統合
- `tests/aiResponseParser*.test.ts` - テストスイート
- `docs/AI_EDIT_SEARCH_REPLACE_PARSING.md` - 詳細ドキュメント（英語）
