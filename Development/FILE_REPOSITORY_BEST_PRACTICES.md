## FileRepository 最適化とキャッシュのベストプラクティス

このドキュメントは、`src/engine/core/filerepository/` に導入した最適化（複合インデックス、プレフィックス検索、単一ファイル取得）と、それに基づく使用上のベストプラクティスをまとめたものです。

目的
- 大規模なプロジェクト（数千〜数万ファイル）でのメモリ使用と応答時間を改善する。
- クライアント側 IndexedDB 操作をできるだけインデックス中心に行い、全件読み出しを避ける。

概観（設計の要点）
- DB バージョンを上げ、`files` オブジェクトストアに複合インデックス `projectId_path` を追加しました。
  - これにより `[projectId, path]` による単一ファイル取得、あるいはプレフィックスを使った範囲検索が高速に実行できます。
- 追加 API
  - `getFileByPath(projectId, path)` — できる限りインデックスで単一ファイルを取得します。
  - `getFilesByPrefix(projectId, prefix)` — `prefix` 配下のファイルを効率的に取得します（インデックスがある場合は範囲検索、それがなければ projectId index を利用して絞り込み、最悪は全件取得でフォールバック）。

なぜこの設計か（理由）
- IndexedDB は全文読み出しが非常に重く、ブラウザメモリを圧迫します。インデックス/範囲検索を多用することで必要なデータだけを読み出せます。
- 複合インデックスを持たせることで、よく使うクエリ（プロジェクト内の特定パスやプレフィックス検索）を低コストにします。

使用上のベストプラクティス

1) 単一ファイルを読む
- 使う API: `getFileByPath(projectId, '/path/to/file')`
- 理由: `getProjectFiles` を呼んで全件からフィルタするより遥かに軽量です。

2) ディレクトリ配下の列挙（ls / tree / grep の再帰）
- 使う API: `getFilesByPrefix(projectId, '/dir/path/')`
- 補足: プレフィックスはプロジェクト相対パス（先頭スラッシュ付き）を想定しています。prefix が `/` なら全体になります。

3) コマンド単位での短期キャッシュ
- 使う場所: コマンド実行中に同一プレフィックスや同一ファイルを複数回参照する場合。
- 実装例: `UnixCommandBase` に `cachedGetFilesByPrefix` / `cachedGetFile` を追加しました。これはインスタンス（＝1コマンド実行）のライフタイム中のみ有効です。
- 注意: UI コンポーネント（例: `FileTree`）ではこのコマンドキャッシュを使わない設計を推奨します。UI はリアルタイム性が求められるため、キャッシュを用いると表示と実際の DB が乖離する可能性があります。

4) フォールバックと互換性
- すべての新 API は、インデックスが存在しない環境を想定してフォールバック経路を持ちます（projectId index を使った絞り込み、最悪は全件取得）。そのため、既存データが残る環境でも壊れにくい設計です。

5) トランザクションと同時実行
- 大量のファイル作成/更新は `createFilesBulk` を利用して DB トランザクションをまとめるとパフォーマンスが改善します。

エッジケースと対処法
- ブラウザがインデックス作成を拒否した場合（まれ）
  - フォールバックで `getFilesByPrefix` は projectId インデックスから絞る挙動を行います。最悪ケースでも機能は維持されますが性能低下します。
- 非同期に GitFileSystem へ同期されるため、即時ファイルシステムのチェックが必要な処理では `fileRepository.saveFile` 成功後に await するか、同期完了フラグを待つ設計が必要です。

運用とアップグレード
- DB version を上げているため、リリース時はマイグレーションの観察が必要です（特にユーザーのローカル IndexedDB に残った古いスキーマ）。
- 既知の安全策: インデックス作成は onupgradeneeded で行い、失敗してもフォールバックできる実装にしています。

ベンチマーク提案
- 大規模モックプロジェクト（例: 10k ファイル）を作成し、以下のシナリオで測定します:
  - 単一ファイル read (getFileByPath)
  - ディレクトリ列挙 (getFilesByPrefix)
  - 全件取得 (getProjectFiles) の時間とメモリ
- ベンチ結果から、getProjectFiles を使う箇所を優先してリファクタします。

推奨コード例（簡潔）
```ts
// 単一ファイル取得
const file = await fileRepository.getFileByPath(projectId, '/src/index.ts');

// ディレクトリ配下取得
const entries = await fileRepository.getFilesByPrefix(projectId, '/src/components/');
```

まとめ
- IndexedDB を使った大規模ファイル操作では、インデックスと範囲検索が鍵です。`getFileByPath` と `getFilesByPrefix` を第一選択とし、コマンド単位の短期キャッシュを活用してください。UI コンポーネントはリアルタイム性を優先して直接取得（キャッシュを使わない）方針を推奨します。

---
ドキュメント作成日: 2025-11-07
